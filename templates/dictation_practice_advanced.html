<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Dictation Practice - Audio Dictation Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .timer-warning { animation: pulse 1s infinite; }
        .typing-area { min-height: 200px; }
        .word-correct { background-color: #dcfce7; color: #166534; }
        .word-incorrect { background-color: #fecaca; color: #dc2626; }
        .word-partial { background-color: #fef3c7; color: #d97706; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-cyan-100 min-h-screen">
    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm border-b">
        <div class="w-full px-2 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="{{ url_for('dictation_practice') }}" class="text-blue-600 hover:text-blue-800">
                        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                        </svg>
                    </a>
                    <h1 class="text-xl font-bold text-gray-800">Advanced Dictation Practice</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600">
                        Welcome, <span class="font-medium">{{ session.username }}</span>
                        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 ml-2">Student</span>
                    </span>
                    <a href="{{ url_for('logout') }}" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 text-sm">Logout</a>
                </div>
            </div>
        </div>
    </nav>

    <div class="w-full px-2 py-8">
        <div class="max-w-6xl mx-auto">
            <!-- Practice Header -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">{{ audio.title }}</h2>
                        <p class="text-gray-600">{{ audio.filename }}</p>
                        {% if audio.duration %}
                            <p class="text-sm text-gray-500">Duration: {{ audio.duration }}s</p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <div id="timer" class="text-3xl font-bold text-blue-600">00:00</div>
                        <div class="text-sm text-gray-500">Time Elapsed</div>
                    </div>
                </div>
            </div>

            <!-- Practice Interface -->
            <div class="grid lg:grid-cols-3 gap-6">
                <!-- Audio Control Panel -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-lg p-6 sticky top-4">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Audio Controls</h3>
                        
                        <!-- Audio Player -->
                        <div class="mb-6">
                            <div class="bg-blue-50 border border-blue-200 rounded p-3 mb-2">
                                <p class="text-blue-800 text-xs font-medium">üéµ Audio Player</p>
                                <p class="text-blue-600 text-xs">Click play to start listening to the audio</p>
                            </div>
                            <audio id="audioPlayer" controls class="w-full" controlsList="nodownload noplaybackrate" preload="metadata">
                                <source src="{{ url_for('uploaded_file', filename=audio.filename) }}" type="audio/mpeg">
                                <source src="{{ url_for('uploaded_file', filename=audio.filename) }}" type="audio/wav">
                                Your browser does not support the audio element.
                            </audio>
                            <div id="audioError" class="mt-2 text-red-600 text-sm" style="display: none;">
                                <p>‚ö†Ô∏è Audio failed to load. Please refresh the page or contact admin.</p>
                            </div>
                        </div>

                        <!-- Practice Settings -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Practice Mode</label>
                                <select id="practiceMode" class="w-full border border-gray-300 rounded px-3 py-2">
                                    <option value="unlimited">Unlimited Time</option>
                                    <option value="timed">Timed Practice (Audio + 30s)</option>
                                    <option value="strict">Strict Mode (Audio Only)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Auto-Submit</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="autoSubmit" class="rounded border-gray-300" checked>
                                    <label for="autoSubmit" class="ml-2 text-sm text-gray-600">Enable auto-submit when time ends</label>
                                </div>
                                <div class="mt-1 text-xs text-gray-500" id="autoSubmitInfo">
                                    ‚Ä¢ Unlimited Mode: No auto-submit<br>
                                    ‚Ä¢ Timed Mode: Auto-submit 3 seconds after audio + 30s<br>
                                    ‚Ä¢ Strict Mode: Auto-submit 3 seconds after audio ends
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Real-time Checking</label>
                                <div class="flex items-center">
                                    <input type="checkbox" id="realTimeCheck" class="rounded border-gray-300">
                                    <label for="realTimeCheck" class="ml-2 text-sm text-gray-600">Highlight words as you type</label>
                                </div>
                            </div>
                        </div>

                        <!-- Start/Stop Buttons -->
                        <div class="mt-6 space-y-2">
                            <button id="startPractice" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 font-medium">
                                Start Practice
                            </button>
                            <button id="pausePractice" class="w-full bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700 font-medium" style="display: none;">
                                Pause Practice
                            </button>
                            <button id="resetPractice" class="w-full bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 font-medium" style="display: none;">
                                Reset Practice
                            </button>
                            <button id="submitPractice" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-medium" style="display: none;">
                                Submit Answer
                            </button>
                        </div>

                        <!-- Progress Stats -->
                        <div class="mt-6 pt-6 border-t border-gray-200">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Live Stats</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span>Words Typed:</span>
                                    <span id="wordsTyped" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Accuracy:</span>
                                    <span id="accuracy" class="font-medium">--</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>WPM:</span>
                                    <span id="wpm" class="font-medium">--</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Area -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Type what you hear</h3>
                        
                        <!-- Instructions -->
                        <div id="instructions" class="bg-blue-50 border border-blue-200 rounded p-4 mb-4">
                            <p class="text-blue-800 text-sm">
                                üéß <strong>Instructions:</strong> Listen to the audio and type exactly what you hear. 
                                Click "Start Practice" to begin the timer and enable typing.
                            </p>
                        </div>

                        <!-- Time Warning -->
                        <div id="timeWarning" class="bg-red-50 border border-red-200 rounded p-4 mb-4 timer-warning" style="display: none;">
                            <p class="text-red-800 text-sm font-medium">
                                ‚è∞ <strong>Time Warning:</strong> <span id="warningMessage"></span>
                            </p>
                        </div>

                        <!-- Typing Area -->
                        <div class="mb-4">
                            <textarea
                                id="typingArea"
                                class="w-full border border-gray-300 rounded px-4 py-3 typing-area resize-none"
                                placeholder="Click 'Start Practice' to begin typing..."
                                disabled
                                spellcheck="false"
                                autocomplete="off"
                                autocorrect="off"
                                autocapitalize="off"
                                style="line-height: 1.2; font-size: 16px; font-family: 'Arial', sans-serif;"
                            ></textarea>
                        </div>

                        <!-- Word Count Display -->
                        <div class="text-sm text-gray-500 mb-4">
                            Character count: <span id="charCount">0</span> | Word count: <span id="wordCount">0</span>
                        </div>

                        <!-- Real-time Feedback Area -->
                        <div id="feedbackArea" class="border border-gray-200 rounded p-4 min-h-[100px] bg-gray-50" style="display: none;">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Real-time Feedback</h4>
                            <div id="feedbackContent" class="text-sm"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Advanced Functionality -->
    <script>
        let practiceStartTime = null;
        let practiceTimer = null;
        let practiceTimeLimit = null;
        let isPracticeActive = false;
        let audioPlayer = null;
        let autoSubmitTimeout = null;
        let AUDIO_DURATION = 60; // Default 60 seconds - will be updated when audio metadata is available

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            audioPlayer = document.getElementById('audioPlayer');
            const typingArea = document.getElementById('typingArea');
            
            // Set up event listeners
            document.getElementById('startPractice').addEventListener('click', startPractice);
            document.getElementById('pausePractice').addEventListener('click', pausePractice);
            document.getElementById('resetPractice').addEventListener('click', resetPractice);
            document.getElementById('submitPractice').addEventListener('click', submitPractice);
            
            // Typing area events
            typingArea.addEventListener('input', handleTypingInput);
            typingArea.addEventListener('keydown', handleKeyDown);
            
            // Practice mode change
            document.getElementById('practiceMode').addEventListener('change', updatePracticeMode);
            
            // Real-time checking toggle
            document.getElementById('realTimeCheck').addEventListener('change', toggleRealTimeCheck);
            
            // Audio player error handling
            audioPlayer.addEventListener('error', function(e) {
                console.error('Audio error:', e);
                document.getElementById('audioError').style.display = 'block';
            });
            
            // Audio player load success
            audioPlayer.addEventListener('loadedmetadata', function() {
                console.log('Audio loaded successfully, duration:', audioPlayer.duration);
                document.getElementById('audioError').style.display = 'none';
                
                // Update the actual audio duration
                if (audioPlayer.duration && !isNaN(audioPlayer.duration)) {
                    AUDIO_DURATION = Math.ceil(audioPlayer.duration);
                    console.log('Updated AUDIO_DURATION to:', AUDIO_DURATION);
                    
                    // Update the duration display if available
                    const durationElement = document.querySelector('p.text-sm.text-gray-500');
                    if (durationElement && durationElement.textContent.includes('Duration:')) {
                        durationElement.textContent = `Duration: ${AUDIO_DURATION}s`;
                    }
                }
            });
            
            // Check audio file accessibility on page load
            audioPlayer.addEventListener('canplay', function() {
                console.log('Audio is ready to play');
            });
            
            // Auto-submit when audio ends in strict mode
            audioPlayer.addEventListener('ended', function() {
                console.log('Audio ended');
                const mode = document.getElementById('practiceMode').value;
                
                if (mode === 'strict' && isPracticeActive) {
                    console.log('Strict mode: Audio ended, triggering auto-submit');
                    
                    // Show warning message
                    const timeWarning = document.getElementById('timeWarning');
                    const warningMessage = document.getElementById('warningMessage');
                    timeWarning.style.display = 'block';
                    warningMessage.textContent = 'Audio finished! Auto-submitting in 3 seconds...';
                    
                    // Auto-submit after 3 seconds if enabled
                    if (document.getElementById('autoSubmit').checked) {
                        setTimeout(function() {
                            if (isPracticeActive) {
                                console.log('Auto-submitting practice results');
                                submitPractice();
                            }
                        }, 3000);
                    } else {
                        // Just stop the practice if auto-submit is disabled
                        isPracticeActive = false;
                        document.getElementById('typingArea').disabled = true;
                        warningMessage.textContent = 'Audio finished! Please submit your results manually.';
                    }
                }
            });
        });

        function startPractice() {
            practiceStartTime = new Date();
            isPracticeActive = true;
            
            // Enable typing area
            const typingArea = document.getElementById('typingArea');
            typingArea.disabled = false;
            typingArea.placeholder = "Start typing what you hear...";
            typingArea.focus();
            
            // Disable all settings during practice
            disableSettings(true);
            
            // Update UI
            document.getElementById('startPractice').style.display = 'none';
            document.getElementById('pausePractice').style.display = 'block';
            document.getElementById('resetPractice').style.display = 'block';
            document.getElementById('submitPractice').style.display = 'block';
            
            // Hide instructions, show timer
            document.getElementById('instructions').style.display = 'none';
            
            // Start timer
            startTimer();
            
            // Set up practice mode
            setupPracticeMode();
            
            // Always start audio when practice begins (all modes)
            console.log('Starting practice - attempting to play audio');
            const mode = document.getElementById('practiceMode').value;
            
            // Reset audio to beginning
            audioPlayer.currentTime = 0;
            
            // Try to play audio for all modes
            const playPromise = audioPlayer.play();
            
            if (playPromise !== undefined) {
                playPromise.then(() => {
                    console.log('Audio started successfully on practice start');
                    // Show success message briefly
                    const instructions = document.getElementById('instructions');
                    instructions.innerHTML = `
                        <p class="text-green-800 text-sm bg-green-50 border border-green-200 rounded p-3">
                            ‚úÖ <strong>Audio is playing!</strong> Listen carefully and type exactly what you hear.
                        </p>
                    `;
                    instructions.style.display = 'block';
                    
                    // Hide the success message after 3 seconds
                    setTimeout(() => {
                        instructions.style.display = 'none';
                    }, 3000);
                }).catch(error => {
                    console.error('Audio autoplay failed:', error);
                    // Show user they need to manually start audio
                    const instructions = document.getElementById('instructions');
                    instructions.innerHTML = `
                        <p class="text-orange-800 text-sm bg-orange-50 border border-orange-200 rounded p-3">
                            üéß <strong>Audio Ready:</strong> Your browser requires manual audio start.
                            <strong>Please click the ‚ñ∂Ô∏è PLAY button on the audio player to begin listening.</strong>
                        </p>
                    `;
                    instructions.style.display = 'block';
                    
                    // Highlight audio player
                    audioPlayer.style.border = '3px solid #F97316';
                    audioPlayer.style.borderRadius = '8px';
                    audioPlayer.style.boxShadow = '0 0 0 3px rgba(249, 115, 22, 0.2)';
                });
            }
        }

        function pausePractice() {
            isPracticeActive = false;
            clearInterval(practiceTimer);
            clearTimeout(autoSubmitTimeout);
            
            // Pause audio and disable typing
            audioPlayer.pause();
            const typingArea = document.getElementById('typingArea');
            typingArea.disabled = true;
            
            // Update UI
            document.getElementById('pausePractice').style.display = 'none';
            document.getElementById('startPractice').style.display = 'block';
            document.getElementById('startPractice').textContent = 'Resume Practice';
        }

        function submitPractice() {
            const typedText = document.getElementById('typingArea').value;
            const practiceEndTime = new Date();
            const totalTime = Math.floor((practiceEndTime - practiceStartTime) / 1000);
            
            // Submit to server
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '{{ url_for("submit_dictation_practice") }}';
            
            const fields = {
                'audio_id': '{{ audio.id }}',
                'transcription': typedText,
                'time_taken': totalTime,
                'practice_mode': document.getElementById('practiceMode').value
            };
            
            Object.keys(fields).forEach(key => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            });
            
            document.body.appendChild(form);
            form.submit();
        }

        function startTimer() {
            practiceTimer = setInterval(function() {
                if (isPracticeActive) {
                    const elapsed = Math.floor((new Date() - practiceStartTime) / 1000);
                    const minutes = Math.floor(elapsed / 60);
                    const seconds = elapsed % 60;
                    document.getElementById('timer').textContent = 
                        String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
                    
                    // Check time limits
                    checkTimeWarnings(elapsed);
                }
            }, 1000);
        }

        function setupPracticeMode() {
            const mode = document.getElementById('practiceMode').value;
            
            if (mode === 'timed') {
                practiceTimeLimit = AUDIO_DURATION + 30; // Audio duration + 30 seconds
                setupAutoSubmit();
            } else if (mode === 'strict') {
                practiceTimeLimit = AUDIO_DURATION;
                setupAutoSubmit();
            } else {
                practiceTimeLimit = null;
            }
        }

        function setupAutoSubmit() {
            if (practiceTimeLimit) {
                autoSubmitTimeout = setTimeout(function() {
                    if (isPracticeActive) {
                        document.getElementById('timeWarning').style.display = 'block';
                        document.getElementById('warningMessage').textContent = 'Time is up! Auto-submitting in 3 seconds...';
                        
                        // Auto-submit after 3 seconds if enabled
                        if (document.getElementById('autoSubmit').checked) {
                            setTimeout(function() {
                                if (isPracticeActive) {
                                    submitPractice();
                                }
                            }, 3000);
                        } else {
                            // Just stop the practice if auto-submit is disabled
                            isPracticeActive = false;
                            document.getElementById('typingArea').disabled = true;
                            audioPlayer.pause();
                            document.getElementById('warningMessage').textContent = 'Time is up! Please submit your results.';
                        }
                    }
                }, practiceTimeLimit * 1000);
            }
        }

        function checkTimeWarnings(elapsed) {
            if (practiceTimeLimit) {
                const remaining = practiceTimeLimit - elapsed;
                
                if (remaining <= 10 && remaining > 0) {
                    document.getElementById('timeWarning').style.display = 'block';
                    document.getElementById('warningMessage').textContent = remaining + ' seconds remaining!';
                } else if (remaining <= 0) {
                    document.getElementById('timeWarning').style.display = 'block';
                    document.getElementById('warningMessage').textContent = 'Time is up!';
                }
            }
        }

        function handleTypingInput(event) {
            const text = event.target.value;
            const words = text.split(/\s+/).filter(word => word.length > 0);
            
            // Update stats
            document.getElementById('charCount').textContent = text.length;
            document.getElementById('wordCount').textContent = words.length;
            document.getElementById('wordsTyped').textContent = words.length;
            
            // Calculate WPM
            if (practiceStartTime) {
                const elapsed = (new Date() - practiceStartTime) / 1000 / 60; // minutes
                const wpm = elapsed > 0 ? Math.round(words.length / elapsed) : 0;
                document.getElementById('wpm').textContent = wpm;
            }
            
            // Real-time checking if enabled
            if (document.getElementById('realTimeCheck').checked) {
                performRealTimeCheck(text);
            }
        }

        function handleKeyDown(event) {
            // Prevent certain keys if in strict mode
            const mode = document.getElementById('practiceMode').value;
            if (mode === 'strict') {
                // Prevent backspace and delete in strict mode
                if (event.key === 'Backspace' || event.key === 'Delete') {
                    event.preventDefault();
                    return false;
                }
            }
        }

        function performRealTimeCheck(text) {
            // This would implement real-time spell/accuracy checking
            // For now, just show basic feedback
            const feedbackArea = document.getElementById('feedbackArea');
            const feedbackContent = document.getElementById('feedbackContent');
            
            feedbackArea.style.display = 'block';
            feedbackContent.innerHTML = '<p class="text-gray-600">Real-time checking: ' + text.length + ' characters typed</p>';
        }

        function toggleRealTimeCheck() {
            const isEnabled = document.getElementById('realTimeCheck').checked;
            const feedbackArea = document.getElementById('feedbackArea');
            
            if (!isEnabled) {
                feedbackArea.style.display = 'none';
            }
        }

        function updatePracticeMode() {
            const mode = document.getElementById('practiceMode').value;
            const typingArea = document.getElementById('typingArea');
            
            // Update placeholder based on mode
            if (mode === 'strict') {
                typingArea.placeholder = "Strict mode: No backspace/delete allowed. Audio will auto-play.";
            } else if (mode === 'timed') {
                typingArea.placeholder = "Timed mode: Audio duration + 30 seconds allowed.";
            } else {
                typingArea.placeholder = "Unlimited mode: Take your time.";
            }
        }
        
        // Function to disable/enable settings during practice
        function disableSettings(disable) {
            const settingsElements = [
                'practiceMode',
                'autoSubmit',
                'realTimeCheck'
            ];
            
            settingsElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.disabled = disable;
                    if (disable) {
                        element.style.opacity = '0.5';
                        element.style.cursor = 'not-allowed';
                    } else {
                        element.style.opacity = '1';
                        element.style.cursor = 'pointer';
                    }
                }
            });
            
            // Also disable audio controls during practice
            const audioPlayer = document.getElementById('audioPlayer');
            if (disable) {
                audioPlayer.style.opacity = '0.7';
                audioPlayer.style.pointerEvents = 'none';
            } else {
                audioPlayer.style.opacity = '1';
                audioPlayer.style.pointerEvents = 'auto';
            }
        }
        
        // Add reset functionality
        function resetPractice() {
            // Reset all variables
            isPracticeActive = false;
            practiceStartTime = null;
            
            // Clear timers
            clearInterval(practiceTimer);
            clearTimeout(autoSubmitTimeout);
            
            // Reset audio
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            
            // Re-enable settings
            disableSettings(false);
            
            // Reset UI
            document.getElementById('typingArea').value = '';
            document.getElementById('typingArea').disabled = true;
            document.getElementById('typingArea').placeholder = "Click 'Start Practice' to begin typing...";
            document.getElementById('timer').textContent = '00:00';
            document.getElementById('startPractice').style.display = 'block';
            document.getElementById('startPractice').textContent = 'Start Practice';
            document.getElementById('pausePractice').style.display = 'none';
            document.getElementById('resetPractice').style.display = 'none';
            document.getElementById('submitPractice').style.display = 'none';
            document.getElementById('instructions').style.display = 'block';
            document.getElementById('timeWarning').style.display = 'none';
            
            // Reset stats
            document.getElementById('charCount').textContent = '0';
            document.getElementById('wordCount').textContent = '0';
            document.getElementById('wordsTyped').textContent = '0';
            document.getElementById('wpm').textContent = '--';
            document.getElementById('accuracy').textContent = '--';
        }
    </script>
</body>
</html>